[bash]
mkdir bucket_experiment && cd bucket_experiment

[python]
from google.cloud import bigquery
   from google.cloud import storage
   import pandas as pd
   import os

   # Project ID - automatically retrieved from environment
   project_id = os.environ['GCP_PROJECT']
   dataset_id = 'experiment'
   table_id = 'tabla_experiment'

   def process_excel(event, context):
       """Cloud Function triggered by file upload to bucket.
       
       Args:
           event (dict): Event payload.
           context (google.cloud.functions.Context): Metadata for the event.
       """
       file = event
       bucket_name = file['bucket']
       file_name = file['name']
       
       # Construct the GCS URI
       gcs_uri = f'gs://{bucket_name}/{file_name}'
       
       # Download the file to a temporary location
       storage_client = storage.Client()
       bucket = storage_client.bucket(bucket_name)
       blob = bucket.blob(file_name)
       blob.download_to_filename('/tmp/temp.xlsx') 

       # Read the Excel file into a Pandas DataFrame
       df = pd.read_excel('/tmp/temp.xlsx') 
       
       if len(df.columns) != 82:
           raise ValueError(f"File {file_name} has incorrect number of columns: {len(df.columns)}")

       # Load data into BigQuery
       bq_client = bigquery.Client()
       table_ref = bq_client.dataset(dataset_id).table(table_id)
       job_config = bigquery.LoadJobConfig(
           source_format=bigquery.SourceFormat.EXCEL,
           autodetect=True, # Attempt to autodetect schema
           write_disposition='WRITE_TRUNCATE' # Replace existing data
       )
       job = bq_client.load_table_from_dataframe(df, table_ref, job_config=job_config)
       job.result()  # Wait for job completion

       print(f"File {file_name} processed and loaded into {dataset_id}.{table_id}")

[bash]
gcloud functions deploy bucket_experiment \
       --runtime python39 \
       --trigger-resource gs://bucket_experiment \
       --trigger-event google.storage.object.finalize \
       --source . \
       --entry-point process_excel

